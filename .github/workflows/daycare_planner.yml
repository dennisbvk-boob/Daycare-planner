name: Daycare Planner

# This workflow runs hourly to transform babysitting entries from a
# Google Sheet into iCalendar invitations sent via email.  The script
# fetches the sheet as a CSV file and sends .ics invites using SMTP.
# See the README for details on configuring secrets.

on:
  #schedule:
    # Every hour on the hour
    #- cron: '0 * * * *'

  # Allow manual runs from the GitHub Actions UI
  workflow_dispatch:

jobs:
  send-invites:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        # Install only the required Python packages: requests and python-dateutil.
        # We no longer use gspread or google-auth because the script reads
        # the sheet via a CSV export URL instead of the Google API.
        run: |
          pip install --no-cache-dir requests python-dateutil

      - name: Run planner script
        # Pass environment variables from repository secrets.  The CSV_URL
        # should be a direct CSV export link to the sheet.  SMTP_USERNAME
        # and SMTP_PASSWORD are required for sending mail.  USER_EMAIL
        # and EMAIL_MAP are optional.  See README for details.
        env:
          CSV_URL: ${{ secrets.CSV_URL }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
          EMAIL_MAP: ${{ secrets.EMAIL_MAP }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: |
          python daycare_planner.py
